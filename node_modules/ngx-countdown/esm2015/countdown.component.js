import { __decorate, __metadata, __param } from "tslib";
import { Component, Input, OnChanges, SimpleChanges, OnDestroy, Output, EventEmitter, OnInit, SimpleChange, ChangeDetectionStrategy, ViewEncapsulation, Inject, LOCALE_ID, ChangeDetectorRef, TemplateRef, NgZone, } from '@angular/core';
import { CountdownStatus } from './interfaces';
import { CountdownTimer } from './countdown.timer';
import { CountdownGlobalConfig } from './countdown.config';
let CountdownComponent = class CountdownComponent {
    constructor(locale, timer, defCog, cdr, ngZone) {
        this.locale = locale;
        this.timer = timer;
        this.defCog = defCog;
        this.cdr = cdr;
        this.ngZone = ngZone;
        this.frequency = 1000;
        this._notify = {};
        this._left = 0;
        this.status = CountdownStatus.ing;
        this.isDestroy = false;
        this.i = {};
        this.event = new EventEmitter();
    }
    get left() {
        return this._left;
    }
    /**
     * Start countdown, you must manually call when `demand: false`
     */
    begin() {
        this.status = CountdownStatus.ing;
        this.callEvent('start');
    }
    /**
     * Restart countdown
     */
    restart() {
        if (this.status !== CountdownStatus.stop) {
            this.destroy();
        }
        this.init();
        this.callEvent('restart');
    }
    /**
     * Stop countdown, must call `restart` when stopped, it's different from pause, unable to recover
     */
    stop() {
        if (this.status === CountdownStatus.stop) {
            return;
        }
        this.status = CountdownStatus.stop;
        this.destroy();
        this.callEvent('stop');
    }
    /**
     * Pause countdown, you can use `resume` to recover again
     */
    pause() {
        if (this.status === CountdownStatus.stop || this.status === CountdownStatus.pause)
            return;
        this.status = CountdownStatus.pause;
        this.callEvent('pause');
    }
    /**
     * Resume countdown
     */
    resume() {
        if (this.status === CountdownStatus.stop || this.status !== CountdownStatus.pause)
            return;
        this.status = CountdownStatus.ing;
        this.callEvent('resume');
    }
    callEvent(action) {
        this.event.emit({ action, left: this._left, status: this.status, text: this.i.text });
    }
    init() {
        const { locale, defCog } = this;
        const config = (this.config = Object.assign(Object.assign(Object.assign({}, new CountdownGlobalConfig(locale)), defCog), this.config));
        // tslint:disable-next-line: no-bitwise
        const frq = (this.frequency = ~config.format.indexOf('S') ? 100 : 1000);
        this.status = config.demand ? CountdownStatus.pause : CountdownStatus.ing;
        this.getLeft();
        // bind reflow to me
        const _reflow = this.reflow;
        this.reflow = (count = 0, force = false) => _reflow.apply(this, [count, force]);
        if (Array.isArray(config.notify)) {
            config.notify.forEach((time) => {
                if (time < 1)
                    throw new Error(`The notify config must be a positive integer.`);
                time = time * 1000;
                time = time - (time % frq);
                this._notify[time] = true;
            });
        }
        this.timer.add(this.reflow, frq).start();
        this.reflow(0, true);
    }
    destroy() {
        this.timer.remove(this.reflow);
        return this;
    }
    /**
     * 更新时钟
     */
    reflow(count = 0, force = false) {
        if (this.isDestroy)
            return;
        const { status, config, _notify } = this;
        if (!force && status !== CountdownStatus.ing)
            return;
        const value = (this._left = this._left - this.frequency * count);
        this.i = {
            value,
            text: config.formatDate({ date: value, formatStr: config.format, timezone: config.timezone }),
        };
        if (typeof config.prettyText === 'function') {
            this.i.text = config.prettyText(this.i.text);
        }
        this.cdr.detectChanges();
        if (config.notify === 0 || _notify[value]) {
            this.ngZone.run(() => {
                this.callEvent('notify');
            });
        }
        if (value < 1) {
            this.ngZone.run(() => {
                this.status = CountdownStatus.done;
                this.callEvent('done');
                this.destroy();
            });
        }
    }
    /**
     * 获取倒计时剩余帧数
     */
    getLeft() {
        const { config, frequency } = this;
        let left = config.leftTime * 1000;
        const end = config.stopTime;
        if (!left && end) {
            left = end - new Date().getTime();
        }
        this._left = left - (left % frequency);
    }
    ngOnInit() {
        this.init();
        if (!this.config.demand) {
            this.begin();
        }
    }
    ngOnDestroy() {
        this.isDestroy = true;
        this.destroy();
    }
    ngOnChanges(changes) {
        if (!changes.config.firstChange) {
            this.restart();
        }
    }
};
CountdownComponent.ctorParameters = () => [
    { type: String, decorators: [{ type: Inject, args: [LOCALE_ID,] }] },
    { type: CountdownTimer },
    { type: CountdownGlobalConfig },
    { type: ChangeDetectorRef },
    { type: NgZone }
];
__decorate([
    Input(),
    __metadata("design:type", Object)
], CountdownComponent.prototype, "config", void 0);
__decorate([
    Input(),
    __metadata("design:type", TemplateRef)
], CountdownComponent.prototype, "render", void 0);
__decorate([
    Output(),
    __metadata("design:type", Object)
], CountdownComponent.prototype, "event", void 0);
CountdownComponent = __decorate([
    Component({
        selector: 'countdown',
        template: `
    <ng-container *ngIf="!render">
      <span [innerHTML]="i.text"></span>
    </ng-container>
    <ng-container *ngTemplateOutlet="render; context: { $implicit: i }"></ng-container>
  `,
        host: { '[class.count-down]': 'true' },
        encapsulation: ViewEncapsulation.None,
        changeDetection: ChangeDetectionStrategy.OnPush
    }),
    __param(0, Inject(LOCALE_ID)),
    __metadata("design:paramtypes", [String, CountdownTimer,
        CountdownGlobalConfig,
        ChangeDetectorRef,
        NgZone])
], CountdownComponent);
export { CountdownComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY291bnRkb3duLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL25neC1jb3VudGRvd24vIiwic291cmNlcyI6WyJjb3VudGRvd24uY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQ0wsU0FBUyxFQUNULEtBQUssRUFDTCxTQUFTLEVBQ1QsYUFBYSxFQUNiLFNBQVMsRUFDVCxNQUFNLEVBQ04sWUFBWSxFQUNaLE1BQU0sRUFDTixZQUFZLEVBQ1osdUJBQXVCLEVBQ3ZCLGlCQUFpQixFQUNqQixNQUFNLEVBQ04sU0FBUyxFQUNULGlCQUFpQixFQUNqQixXQUFXLEVBQ1gsTUFBTSxHQUNQLE1BQU0sZUFBZSxDQUFDO0FBRXZCLE9BQU8sRUFBbUIsZUFBZSxFQUF1RCxNQUFNLGNBQWMsQ0FBQztBQUNySCxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDbkQsT0FBTyxFQUFFLHFCQUFxQixFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFjM0QsSUFBYSxrQkFBa0IsR0FBL0IsTUFBYSxrQkFBa0I7SUFZN0IsWUFDNkIsTUFBYyxFQUNqQyxLQUFxQixFQUNyQixNQUE2QixFQUM3QixHQUFzQixFQUN0QixNQUFjO1FBSkssV0FBTSxHQUFOLE1BQU0sQ0FBUTtRQUNqQyxVQUFLLEdBQUwsS0FBSyxDQUFnQjtRQUNyQixXQUFNLEdBQU4sTUFBTSxDQUF1QjtRQUM3QixRQUFHLEdBQUgsR0FBRyxDQUFtQjtRQUN0QixXQUFNLEdBQU4sTUFBTSxDQUFRO1FBaEJoQixjQUFTLEdBQUcsSUFBSSxDQUFDO1FBQ2pCLFlBQU8sR0FBUSxFQUFFLENBQUM7UUFDbEIsVUFBSyxHQUFHLENBQUMsQ0FBQztRQUNWLFdBQU0sR0FBb0IsZUFBZSxDQUFDLEdBQUcsQ0FBQztRQUM5QyxjQUFTLEdBQUcsS0FBSyxDQUFDO1FBQzFCLE1BQUMsR0FBa0IsRUFBRSxDQUFDO1FBSUgsVUFBSyxHQUFHLElBQUksWUFBWSxFQUFrQixDQUFDO0lBUTNELENBQUM7SUFFSixJQUFJLElBQUk7UUFDTixPQUFPLElBQUksQ0FBQyxLQUFLLENBQUM7SUFDcEIsQ0FBQztJQUVEOztPQUVHO0lBQ0gsS0FBSztRQUNILElBQUksQ0FBQyxNQUFNLEdBQUcsZUFBZSxDQUFDLEdBQUcsQ0FBQztRQUNsQyxJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQzFCLENBQUM7SUFFRDs7T0FFRztJQUNILE9BQU87UUFDTCxJQUFJLElBQUksQ0FBQyxNQUFNLEtBQUssZUFBZSxDQUFDLElBQUksRUFBRTtZQUN4QyxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUM7U0FDaEI7UUFDRCxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDWixJQUFJLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQzVCLENBQUM7SUFFRDs7T0FFRztJQUNILElBQUk7UUFDRixJQUFJLElBQUksQ0FBQyxNQUFNLEtBQUssZUFBZSxDQUFDLElBQUksRUFBRTtZQUN4QyxPQUFPO1NBQ1I7UUFDRCxJQUFJLENBQUMsTUFBTSxHQUFHLGVBQWUsQ0FBQyxJQUFJLENBQUM7UUFDbkMsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBQ2YsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUN6QixDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLO1FBQ0gsSUFBSSxJQUFJLENBQUMsTUFBTSxLQUFLLGVBQWUsQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLE1BQU0sS0FBSyxlQUFlLENBQUMsS0FBSztZQUFFLE9BQU87UUFDMUYsSUFBSSxDQUFDLE1BQU0sR0FBRyxlQUFlLENBQUMsS0FBSyxDQUFDO1FBQ3BDLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDMUIsQ0FBQztJQUVEOztPQUVHO0lBQ0gsTUFBTTtRQUNKLElBQUksSUFBSSxDQUFDLE1BQU0sS0FBSyxlQUFlLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxNQUFNLEtBQUssZUFBZSxDQUFDLEtBQUs7WUFBRSxPQUFPO1FBQzFGLElBQUksQ0FBQyxNQUFNLEdBQUcsZUFBZSxDQUFDLEdBQUcsQ0FBQztRQUNsQyxJQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQzNCLENBQUM7SUFFTyxTQUFTLENBQUMsTUFBNEI7UUFDNUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxLQUFLLEVBQUUsTUFBTSxFQUFFLElBQUksQ0FBQyxNQUFNLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQztJQUN4RixDQUFDO0lBRU8sSUFBSTtRQUNWLE1BQU0sRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLEdBQUcsSUFBSSxDQUFDO1FBQ2hDLE1BQU0sTUFBTSxHQUFHLENBQUMsSUFBSSxDQUFDLE1BQU0saURBQ3RCLElBQUkscUJBQXFCLENBQUMsTUFBTSxDQUFDLEdBQ2pDLE1BQU0sR0FDTixJQUFJLENBQUMsTUFBTSxDQUNmLENBQUMsQ0FBQztRQUNILHVDQUF1QztRQUN2QyxNQUFNLEdBQUcsR0FBRyxDQUFDLElBQUksQ0FBQyxTQUFTLEdBQUcsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN4RSxJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLGVBQWUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLGVBQWUsQ0FBQyxHQUFHLENBQUM7UUFFMUUsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBRWYsb0JBQW9CO1FBQ3BCLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUM7UUFDNUIsSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFDLFFBQWdCLENBQUMsRUFBRSxRQUFpQixLQUFLLEVBQUUsRUFBRSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLENBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQyxDQUFDLENBQUM7UUFFakcsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRTtZQUNoQyxNQUFNLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQVksRUFBRSxFQUFFO2dCQUNyQyxJQUFJLElBQUksR0FBRyxDQUFDO29CQUFFLE1BQU0sSUFBSSxLQUFLLENBQUMsK0NBQStDLENBQUMsQ0FBQztnQkFFL0UsSUFBSSxHQUFHLElBQUksR0FBRyxJQUFJLENBQUM7Z0JBQ25CLElBQUksR0FBRyxJQUFJLEdBQUcsQ0FBQyxJQUFJLEdBQUcsR0FBRyxDQUFDLENBQUM7Z0JBQzNCLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDO1lBQzVCLENBQUMsQ0FBQyxDQUFDO1NBQ0o7UUFFRCxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxDQUFDLEtBQUssRUFBRSxDQUFDO1FBRXpDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQ3ZCLENBQUM7SUFFTyxPQUFPO1FBQ2IsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQy9CLE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQztJQUVEOztPQUVHO0lBQ0ssTUFBTSxDQUFDLFFBQWdCLENBQUMsRUFBRSxRQUFpQixLQUFLO1FBQ3RELElBQUksSUFBSSxDQUFDLFNBQVM7WUFBRSxPQUFPO1FBRTNCLE1BQU0sRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLE9BQU8sRUFBRSxHQUFHLElBQUksQ0FBQztRQUN6QyxJQUFJLENBQUMsS0FBSyxJQUFJLE1BQU0sS0FBSyxlQUFlLENBQUMsR0FBRztZQUFFLE9BQU87UUFFckQsTUFBTSxLQUFLLEdBQUcsQ0FBQyxJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLFNBQVMsR0FBRyxLQUFLLENBQUMsQ0FBQztRQUNqRSxJQUFJLENBQUMsQ0FBQyxHQUFHO1lBQ1AsS0FBSztZQUNMLElBQUksRUFBRSxNQUFNLENBQUMsVUFBVSxDQUFDLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsTUFBTSxDQUFDLE1BQU0sRUFBRSxRQUFRLEVBQUUsTUFBTSxDQUFDLFFBQVEsRUFBRSxDQUFDO1NBQzlGLENBQUM7UUFDRixJQUFJLE9BQU8sTUFBTSxDQUFDLFVBQVUsS0FBSyxVQUFVLEVBQUU7WUFDM0MsSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJLEdBQUcsTUFBTSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQzlDO1FBQ0QsSUFBSSxDQUFDLEdBQUcsQ0FBQyxhQUFhLEVBQUUsQ0FBQztRQUV6QixJQUFJLE1BQU0sQ0FBQyxNQUFNLEtBQUssQ0FBQyxJQUFJLE9BQU8sQ0FBQyxLQUFLLENBQUMsRUFBRTtZQUN6QyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUU7Z0JBQ25CLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDM0IsQ0FBQyxDQUFDLENBQUM7U0FDSjtRQUVELElBQUksS0FBSyxHQUFHLENBQUMsRUFBRTtZQUNiLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRTtnQkFDbkIsSUFBSSxDQUFDLE1BQU0sR0FBRyxlQUFlLENBQUMsSUFBSSxDQUFDO2dCQUNuQyxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxDQUFDO2dCQUN2QixJQUFJLENBQUMsT0FBTyxFQUFFLENBQUM7WUFDakIsQ0FBQyxDQUFDLENBQUM7U0FDSjtJQUNILENBQUM7SUFFRDs7T0FFRztJQUNLLE9BQU87UUFDYixNQUFNLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBRSxHQUFHLElBQUksQ0FBQztRQUNuQyxJQUFJLElBQUksR0FBRyxNQUFNLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQztRQUNsQyxNQUFNLEdBQUcsR0FBRyxNQUFNLENBQUMsUUFBUSxDQUFDO1FBRTVCLElBQUksQ0FBQyxJQUFJLElBQUksR0FBRyxFQUFFO1lBQ2hCLElBQUksR0FBRyxHQUFHLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQyxPQUFPLEVBQUUsQ0FBQztTQUNuQztRQUVELElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxHQUFHLENBQUMsSUFBSSxHQUFHLFNBQVMsQ0FBQyxDQUFDO0lBQ3pDLENBQUM7SUFFRCxRQUFRO1FBQ04sSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ1osSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxFQUFFO1lBQ3ZCLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztTQUNkO0lBQ0gsQ0FBQztJQUVELFdBQVc7UUFDVCxJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQztRQUN0QixJQUFJLENBQUMsT0FBTyxFQUFFLENBQUM7SUFDakIsQ0FBQztJQUVELFdBQVcsQ0FBQyxPQUE2RDtRQUN2RSxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxXQUFXLEVBQUU7WUFDL0IsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDO1NBQ2hCO0lBQ0gsQ0FBQztDQUNGLENBQUE7O3lDQXZLSSxNQUFNLFNBQUMsU0FBUztZQUNGLGNBQWM7WUFDYixxQkFBcUI7WUFDeEIsaUJBQWlCO1lBQ2QsTUFBTTs7QUFUZjtJQUFSLEtBQUssRUFBRTs7a0RBQXlCO0FBQ3hCO0lBQVIsS0FBSyxFQUFFOzhCQUFTLFdBQVc7a0RBQU87QUFDekI7SUFBVCxNQUFNLEVBQUU7O2lEQUFxRDtBQVZuRCxrQkFBa0I7SUFaOUIsU0FBUyxDQUFDO1FBQ1QsUUFBUSxFQUFFLFdBQVc7UUFDckIsUUFBUSxFQUFFOzs7OztHQUtUO1FBQ0QsSUFBSSxFQUFFLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSxFQUFFO1FBQ3RDLGFBQWEsRUFBRSxpQkFBaUIsQ0FBQyxJQUFJO1FBQ3JDLGVBQWUsRUFBRSx1QkFBdUIsQ0FBQyxNQUFNO0tBQ2hELENBQUM7SUFjRyxXQUFBLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQTs2Q0FDSCxjQUFjO1FBQ2IscUJBQXFCO1FBQ3hCLGlCQUFpQjtRQUNkLE1BQU07R0FqQmIsa0JBQWtCLENBb0w5QjtTQXBMWSxrQkFBa0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBDb21wb25lbnQsXG4gIElucHV0LFxuICBPbkNoYW5nZXMsXG4gIFNpbXBsZUNoYW5nZXMsXG4gIE9uRGVzdHJveSxcbiAgT3V0cHV0LFxuICBFdmVudEVtaXR0ZXIsXG4gIE9uSW5pdCxcbiAgU2ltcGxlQ2hhbmdlLFxuICBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneSxcbiAgVmlld0VuY2Fwc3VsYXRpb24sXG4gIEluamVjdCxcbiAgTE9DQUxFX0lELFxuICBDaGFuZ2VEZXRlY3RvclJlZixcbiAgVGVtcGxhdGVSZWYsXG4gIE5nWm9uZSxcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5cbmltcG9ydCB7IENvdW50ZG93bkNvbmZpZywgQ291bnRkb3duU3RhdHVzLCBDb3VudGRvd25FdmVudCwgQ291bnRkb3duRXZlbnRBY3Rpb24sIENvdW50ZG93bkl0ZW0gfSBmcm9tICcuL2ludGVyZmFjZXMnO1xuaW1wb3J0IHsgQ291bnRkb3duVGltZXIgfSBmcm9tICcuL2NvdW50ZG93bi50aW1lcic7XG5pbXBvcnQgeyBDb3VudGRvd25HbG9iYWxDb25maWcgfSBmcm9tICcuL2NvdW50ZG93bi5jb25maWcnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdjb3VudGRvd24nLFxuICB0ZW1wbGF0ZTogYFxuICAgIDxuZy1jb250YWluZXIgKm5nSWY9XCIhcmVuZGVyXCI+XG4gICAgICA8c3BhbiBbaW5uZXJIVE1MXT1cImkudGV4dFwiPjwvc3Bhbj5cbiAgICA8L25nLWNvbnRhaW5lcj5cbiAgICA8bmctY29udGFpbmVyICpuZ1RlbXBsYXRlT3V0bGV0PVwicmVuZGVyOyBjb250ZXh0OiB7ICRpbXBsaWNpdDogaSB9XCI+PC9uZy1jb250YWluZXI+XG4gIGAsXG4gIGhvc3Q6IHsgJ1tjbGFzcy5jb3VudC1kb3duXSc6ICd0cnVlJyB9LFxuICBlbmNhcHN1bGF0aW9uOiBWaWV3RW5jYXBzdWxhdGlvbi5Ob25lLFxuICBjaGFuZ2VEZXRlY3Rpb246IENoYW5nZURldGVjdGlvblN0cmF0ZWd5Lk9uUHVzaCxcbn0pXG5leHBvcnQgY2xhc3MgQ291bnRkb3duQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0LCBPbkNoYW5nZXMsIE9uRGVzdHJveSB7XG4gIHByaXZhdGUgZnJlcXVlbmN5ID0gMTAwMDtcbiAgcHJpdmF0ZSBfbm90aWZ5OiBhbnkgPSB7fTtcbiAgcHJpdmF0ZSBfbGVmdCA9IDA7XG4gIHByaXZhdGUgc3RhdHVzOiBDb3VudGRvd25TdGF0dXMgPSBDb3VudGRvd25TdGF0dXMuaW5nO1xuICBwcml2YXRlIGlzRGVzdHJveSA9IGZhbHNlO1xuICBpOiBDb3VudGRvd25JdGVtID0ge307XG5cbiAgQElucHV0KCkgY29uZmlnOiBDb3VudGRvd25Db25maWc7XG4gIEBJbnB1dCgpIHJlbmRlcjogVGVtcGxhdGVSZWY8dm9pZD47XG4gIEBPdXRwdXQoKSByZWFkb25seSBldmVudCA9IG5ldyBFdmVudEVtaXR0ZXI8Q291bnRkb3duRXZlbnQ+KCk7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgQEluamVjdChMT0NBTEVfSUQpIHByaXZhdGUgbG9jYWxlOiBzdHJpbmcsXG4gICAgcHJpdmF0ZSB0aW1lcjogQ291bnRkb3duVGltZXIsXG4gICAgcHJpdmF0ZSBkZWZDb2c6IENvdW50ZG93bkdsb2JhbENvbmZpZyxcbiAgICBwcml2YXRlIGNkcjogQ2hhbmdlRGV0ZWN0b3JSZWYsXG4gICAgcHJpdmF0ZSBuZ1pvbmU6IE5nWm9uZSxcbiAgKSB7fVxuXG4gIGdldCBsZWZ0KCkge1xuICAgIHJldHVybiB0aGlzLl9sZWZ0O1xuICB9XG5cbiAgLyoqXG4gICAqIFN0YXJ0IGNvdW50ZG93biwgeW91IG11c3QgbWFudWFsbHkgY2FsbCB3aGVuIGBkZW1hbmQ6IGZhbHNlYFxuICAgKi9cbiAgYmVnaW4oKSB7XG4gICAgdGhpcy5zdGF0dXMgPSBDb3VudGRvd25TdGF0dXMuaW5nO1xuICAgIHRoaXMuY2FsbEV2ZW50KCdzdGFydCcpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlc3RhcnQgY291bnRkb3duXG4gICAqL1xuICByZXN0YXJ0KCk6IHZvaWQge1xuICAgIGlmICh0aGlzLnN0YXR1cyAhPT0gQ291bnRkb3duU3RhdHVzLnN0b3ApIHtcbiAgICAgIHRoaXMuZGVzdHJveSgpO1xuICAgIH1cbiAgICB0aGlzLmluaXQoKTtcbiAgICB0aGlzLmNhbGxFdmVudCgncmVzdGFydCcpO1xuICB9XG5cbiAgLyoqXG4gICAqIFN0b3AgY291bnRkb3duLCBtdXN0IGNhbGwgYHJlc3RhcnRgIHdoZW4gc3RvcHBlZCwgaXQncyBkaWZmZXJlbnQgZnJvbSBwYXVzZSwgdW5hYmxlIHRvIHJlY292ZXJcbiAgICovXG4gIHN0b3AoKSB7XG4gICAgaWYgKHRoaXMuc3RhdHVzID09PSBDb3VudGRvd25TdGF0dXMuc3RvcCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLnN0YXR1cyA9IENvdW50ZG93blN0YXR1cy5zdG9wO1xuICAgIHRoaXMuZGVzdHJveSgpO1xuICAgIHRoaXMuY2FsbEV2ZW50KCdzdG9wJyk7XG4gIH1cblxuICAvKipcbiAgICogUGF1c2UgY291bnRkb3duLCB5b3UgY2FuIHVzZSBgcmVzdW1lYCB0byByZWNvdmVyIGFnYWluXG4gICAqL1xuICBwYXVzZSgpIHtcbiAgICBpZiAodGhpcy5zdGF0dXMgPT09IENvdW50ZG93blN0YXR1cy5zdG9wIHx8IHRoaXMuc3RhdHVzID09PSBDb3VudGRvd25TdGF0dXMucGF1c2UpIHJldHVybjtcbiAgICB0aGlzLnN0YXR1cyA9IENvdW50ZG93blN0YXR1cy5wYXVzZTtcbiAgICB0aGlzLmNhbGxFdmVudCgncGF1c2UnKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXN1bWUgY291bnRkb3duXG4gICAqL1xuICByZXN1bWUoKSB7XG4gICAgaWYgKHRoaXMuc3RhdHVzID09PSBDb3VudGRvd25TdGF0dXMuc3RvcCB8fCB0aGlzLnN0YXR1cyAhPT0gQ291bnRkb3duU3RhdHVzLnBhdXNlKSByZXR1cm47XG4gICAgdGhpcy5zdGF0dXMgPSBDb3VudGRvd25TdGF0dXMuaW5nO1xuICAgIHRoaXMuY2FsbEV2ZW50KCdyZXN1bWUnKTtcbiAgfVxuXG4gIHByaXZhdGUgY2FsbEV2ZW50KGFjdGlvbjogQ291bnRkb3duRXZlbnRBY3Rpb24pIHtcbiAgICB0aGlzLmV2ZW50LmVtaXQoeyBhY3Rpb24sIGxlZnQ6IHRoaXMuX2xlZnQsIHN0YXR1czogdGhpcy5zdGF0dXMsIHRleHQ6IHRoaXMuaS50ZXh0IH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBpbml0KCkge1xuICAgIGNvbnN0IHsgbG9jYWxlLCBkZWZDb2cgfSA9IHRoaXM7XG4gICAgY29uc3QgY29uZmlnID0gKHRoaXMuY29uZmlnID0ge1xuICAgICAgLi4ubmV3IENvdW50ZG93bkdsb2JhbENvbmZpZyhsb2NhbGUpLFxuICAgICAgLi4uZGVmQ29nLFxuICAgICAgLi4udGhpcy5jb25maWcsXG4gICAgfSk7XG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBuby1iaXR3aXNlXG4gICAgY29uc3QgZnJxID0gKHRoaXMuZnJlcXVlbmN5ID0gfmNvbmZpZy5mb3JtYXQuaW5kZXhPZignUycpID8gMTAwIDogMTAwMCk7XG4gICAgdGhpcy5zdGF0dXMgPSBjb25maWcuZGVtYW5kID8gQ291bnRkb3duU3RhdHVzLnBhdXNlIDogQ291bnRkb3duU3RhdHVzLmluZztcblxuICAgIHRoaXMuZ2V0TGVmdCgpO1xuXG4gICAgLy8gYmluZCByZWZsb3cgdG8gbWVcbiAgICBjb25zdCBfcmVmbG93ID0gdGhpcy5yZWZsb3c7XG4gICAgdGhpcy5yZWZsb3cgPSAoY291bnQ6IG51bWJlciA9IDAsIGZvcmNlOiBib29sZWFuID0gZmFsc2UpID0+IF9yZWZsb3cuYXBwbHkodGhpcywgW2NvdW50LCBmb3JjZV0pO1xuXG4gICAgaWYgKEFycmF5LmlzQXJyYXkoY29uZmlnLm5vdGlmeSkpIHtcbiAgICAgIGNvbmZpZy5ub3RpZnkuZm9yRWFjaCgodGltZTogbnVtYmVyKSA9PiB7XG4gICAgICAgIGlmICh0aW1lIDwgMSkgdGhyb3cgbmV3IEVycm9yKGBUaGUgbm90aWZ5IGNvbmZpZyBtdXN0IGJlIGEgcG9zaXRpdmUgaW50ZWdlci5gKTtcblxuICAgICAgICB0aW1lID0gdGltZSAqIDEwMDA7XG4gICAgICAgIHRpbWUgPSB0aW1lIC0gKHRpbWUgJSBmcnEpO1xuICAgICAgICB0aGlzLl9ub3RpZnlbdGltZV0gPSB0cnVlO1xuICAgICAgfSk7XG4gICAgfVxuXG4gICAgdGhpcy50aW1lci5hZGQodGhpcy5yZWZsb3csIGZycSkuc3RhcnQoKTtcblxuICAgIHRoaXMucmVmbG93KDAsIHRydWUpO1xuICB9XG5cbiAgcHJpdmF0ZSBkZXN0cm95KCkge1xuICAgIHRoaXMudGltZXIucmVtb3ZlKHRoaXMucmVmbG93KTtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIC8qKlxuICAgKiDmm7TmlrDml7bpkp9cbiAgICovXG4gIHByaXZhdGUgcmVmbG93KGNvdW50OiBudW1iZXIgPSAwLCBmb3JjZTogYm9vbGVhbiA9IGZhbHNlKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuaXNEZXN0cm95KSByZXR1cm47XG5cbiAgICBjb25zdCB7IHN0YXR1cywgY29uZmlnLCBfbm90aWZ5IH0gPSB0aGlzO1xuICAgIGlmICghZm9yY2UgJiYgc3RhdHVzICE9PSBDb3VudGRvd25TdGF0dXMuaW5nKSByZXR1cm47XG5cbiAgICBjb25zdCB2YWx1ZSA9ICh0aGlzLl9sZWZ0ID0gdGhpcy5fbGVmdCAtIHRoaXMuZnJlcXVlbmN5ICogY291bnQpO1xuICAgIHRoaXMuaSA9IHtcbiAgICAgIHZhbHVlLFxuICAgICAgdGV4dDogY29uZmlnLmZvcm1hdERhdGUoeyBkYXRlOiB2YWx1ZSwgZm9ybWF0U3RyOiBjb25maWcuZm9ybWF0LCB0aW1lem9uZTogY29uZmlnLnRpbWV6b25lIH0pLFxuICAgIH07XG4gICAgaWYgKHR5cGVvZiBjb25maWcucHJldHR5VGV4dCA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgdGhpcy5pLnRleHQgPSBjb25maWcucHJldHR5VGV4dCh0aGlzLmkudGV4dCk7XG4gICAgfVxuICAgIHRoaXMuY2RyLmRldGVjdENoYW5nZXMoKTtcblxuICAgIGlmIChjb25maWcubm90aWZ5ID09PSAwIHx8IF9ub3RpZnlbdmFsdWVdKSB7XG4gICAgICB0aGlzLm5nWm9uZS5ydW4oKCkgPT4ge1xuICAgICAgICB0aGlzLmNhbGxFdmVudCgnbm90aWZ5Jyk7XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBpZiAodmFsdWUgPCAxKSB7XG4gICAgICB0aGlzLm5nWm9uZS5ydW4oKCkgPT4ge1xuICAgICAgICB0aGlzLnN0YXR1cyA9IENvdW50ZG93blN0YXR1cy5kb25lO1xuICAgICAgICB0aGlzLmNhbGxFdmVudCgnZG9uZScpO1xuICAgICAgICB0aGlzLmRlc3Ryb3koKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiDojrflj5blgJLorqHml7bliankvZnluKfmlbBcbiAgICovXG4gIHByaXZhdGUgZ2V0TGVmdCgpOiB2b2lkIHtcbiAgICBjb25zdCB7IGNvbmZpZywgZnJlcXVlbmN5IH0gPSB0aGlzO1xuICAgIGxldCBsZWZ0ID0gY29uZmlnLmxlZnRUaW1lICogMTAwMDtcbiAgICBjb25zdCBlbmQgPSBjb25maWcuc3RvcFRpbWU7XG5cbiAgICBpZiAoIWxlZnQgJiYgZW5kKSB7XG4gICAgICBsZWZ0ID0gZW5kIC0gbmV3IERhdGUoKS5nZXRUaW1lKCk7XG4gICAgfVxuXG4gICAgdGhpcy5fbGVmdCA9IGxlZnQgLSAobGVmdCAlIGZyZXF1ZW5jeSk7XG4gIH1cblxuICBuZ09uSW5pdCgpIHtcbiAgICB0aGlzLmluaXQoKTtcbiAgICBpZiAoIXRoaXMuY29uZmlnLmRlbWFuZCkge1xuICAgICAgdGhpcy5iZWdpbigpO1xuICAgIH1cbiAgfVxuXG4gIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICAgIHRoaXMuaXNEZXN0cm95ID0gdHJ1ZTtcbiAgICB0aGlzLmRlc3Ryb3koKTtcbiAgfVxuXG4gIG5nT25DaGFuZ2VzKGNoYW5nZXM6IHsgW1AgaW4ga2V5b2YgdGhpc10/OiBTaW1wbGVDaGFuZ2UgfSAmIFNpbXBsZUNoYW5nZXMpOiB2b2lkIHtcbiAgICBpZiAoIWNoYW5nZXMuY29uZmlnLmZpcnN0Q2hhbmdlKSB7XG4gICAgICB0aGlzLnJlc3RhcnQoKTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==